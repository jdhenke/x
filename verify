#!/usr/bin/env bash

## Check binary equality (black box)
# C = Scc = Icc = Cc
# I = Sci = Ici = Ci
# T = Sct = Ict = Ct

## Check output equality (glass box)
# St = It = Ct

set -e -o pipefail

c() {
  comp=$1
  base=$(basename $2 .x)
  cat xc.ll > /tmp/$base.ll && cat std.x $2 | $comp >> /tmp/$base.ll
  clang -Wno-override-module -lgc /tmp/$base.ll -o /tmp/$base
}

eq() {
  [ "$(md5 -q $1)" = "$(md5 -q $2)" ]
}

# Bootstrap C
echo "C := Scc"
/usr/bin/time ./xs -o /tmp/xc < <(cat xc.x xc.x)
mv /tmp/xc /tmp/xc1

# Bootstrap I
echo "I := Sci"
/usr/bin/time ./xs -o /tmp/xi < <(cat xc.x xi.x)
mv /tmp/xi /tmp/xi1

# C = Cc
echo "C == Cc"
/usr/bin/time /tmp/xc1 -o /tmp/xc < xc.x
mv /tmp/xc /tmp/xc2
eq /tmp/xc1 /tmp/xc2

# C = Icc
echo "C == Icc"
/usr/bin/time /tmp/xi1 -o /tmp/xc < <(cat xc.x xc.x)
mv /tmp/xc /tmp/xc3
eq /tmp/xc1 /tmp/xc3

# I = Ci
echo "I == Ci"
/usr/bin/time /tmp/xc1 -o /tmp/xi < xi.x
mv /tmp/xi /tmp/xi2
eq /tmp/xi1 /tmp/xi2

# I = Ici
echo "I == Ici"
/usr/bin/time /tmp/xi1 -o /tmp/xi < <(cat xc.x xi.x)
mv /tmp/xi /tmp/xi3
eq /tmp/xi1 /tmp/xi3

# T = St
echo "T := St"
/usr/bin/time ./xs < test.x | tee /tmp/t1

# T = It
echo "T == It"
/usr/bin/time /tmp/xi1 < test.x | tee /tmp/t2
eq /tmp/t1 /tmp/t2

# T = Ct
echo "T == Ct"
/usr/bin/time /tmp/xc1 < test.x | tee /tmp/t3
eq /tmp/t1 /tmp/t3

echo PASS
